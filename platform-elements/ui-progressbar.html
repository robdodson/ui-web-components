<link rel="import" href="ui-widget.html">

<template class="value-tmpl">
	<style>
		:host {
			display: block;
			height: 2em;
			text-align: left;
			overflow: hidden;
		}
		.ui-progressbar-value {
			margin: -1px;
			height: 100%;
		}
		.ui-progressbar-overlay {
			background: url("data:image/gif;base64,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");
			height: 100%;
			filter: alpha(opacity=25);
			opacity: 0.25;
		}
		.ui-progressbar-indeterminate .ui-progressbar-value {
			background-image: none;
		}
	</style>
	<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>
</template>

<template class="overlay-tmpl">
	<div class='ui-progressbar-overlay'></div>
</template>

<script>
	var valueTmpl = document._currentScript.ownerDocument
			.querySelector('.value-tmpl');
	var overlayTmpl = document._currentScript.ownerDocument
			.querySelector('.overlay-tmpl')
	var proto = Object.create( $.ui.widget );

	$.extend( proto, {
		createdCallback: function() {
			// TODO: Wire up some sort of super() mechanism?
			this.init();

			var value;
			this.min = 0;

			this.element
				.addClass( "ui-widget ui-widget-content ui-corner-all" )
				.attr({
					role: "progressbar",
					"aria-valuemin": this.min
				});

			// There HAS to be a better way of doing this... right?
			// Polymer has the "attributes" attribute, but that's not a
			// part of the platform.
			value = this.element.attr( "value" );
			this.value = value === "false" ? false :
				parseInt( value, 10 );
			this.max = parseInt( this.element.attr( "max" ), 10 );
			this._handleDisabled( this.element.is( "[disabled]" ) );

			// Constrain initial value
			this.oldValue = this.value = this._constrainedValue();

			// Create shadowRoot
			this.shadowRoot = this.createShadowRoot();
			this.shadowRoot.appendChild(
					document.importNode( valueTmpl.content, true
			) );
			this.valueDiv = $(
					this.shadowRoot.querySelector('.ui-progressbar-value')
			);

			this._refreshValue();
			this.initialized = true;
		},

		attributeChangedCallback: function( name, oldValue, newValue ) {
			if ( !this.initialized ) {
				return;
			}
			if ( name === "value" ) {
				this.value = newValue === "false" ? false :
					parseInt( newValue, 10 );
				this.value = this._constrainedValue( this.value );
			}
			if ( name === "max" ) {
				// Don't allow a max less than min
				this.max = Math.max( this.min, parseInt( newValue, 10 ) );
			}
			if ( name === "disabled" ) {
				this._handleDisabled( this.element.is( "[disabled]" ) );
			}
			this._refreshValue();
		},

		_handleDisabled: function( value ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
			this.disabled = !!value;
		},

		_percentage: function() {
			return this.indeterminate ? 100 : 100 * ( this.value - this.min ) / ( this.max - this.min );
		},

		_constrainedValue: function( newValue ) {
			if ( newValue === undefined ) {
				newValue = this.value;
			}

			this.indeterminate = newValue === false;

			// sanitize value
			if ( typeof newValue !== "number" ) {
				newValue = 0;
			}

			return this.indeterminate ? false :
				Math.min( this.max, Math.max( this.min, newValue ) );
		},

		_refreshValue: function() {
			var value = this.value,
				percentage = this._percentage();

			this.valueDiv
				.toggle( this.indeterminate || value > this.min )
				.toggleClass( "ui-corner-right", value === this.max )
				.width( percentage.toFixed(0) + "%" );

			this.element.toggleClass( "ui-progressbar-indeterminate", this.indeterminate );

			if ( this.indeterminate ) {
				this.element.removeAttr( "aria-valuenow" );
				if ( !this.overlayDiv ) {
					// Writing it this way sets overlayDiv equal to the document fragment
					// and not the instance inserted into the page
					// this.overlayDiv = $(
					// 		document.importNode( overlayTmpl.content, true ) )
					// 		.appendTo( this.valueDiv );
					
					$( document.importNode( overlayTmpl.content, true ) )
							.appendTo( this.valueDiv );
					this.overlayDiv = this.valueDiv.find('.ui-progressbar-overlay');
				}
			} else {
				this.element.attr({
					"aria-valuemax": this.max,
					"aria-valuenow": value
				});
				if ( this.overlayDiv ) {
					this.overlayDiv.remove();
					this.overlayDiv = null;
				}
			}

			if ( this.oldValue !== value ) {
				this.oldValue = value;
				this.element.trigger( "change" );
			}
			if ( value === this.max ) {
				this.element.trigger( "complete" );
			}
		}
	});

	$.ui.progressbar = document.registerElement( "ui-progressbar", {
		prototype: proto
	});
</script>
